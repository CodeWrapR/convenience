<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Mileage Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .info-box {
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border-left: 4px solid #2196f3;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #4299e1;
            color: white;
        }

        .tab-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .analytics-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 14px;
            color: #495057;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-filter-btn {
            padding: 8px 16px;
            border: 1px solid #4299e1;
            background: white;
            color: #4299e1;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .quick-filter-btn:hover,
        .quick-filter-btn.active {
            background: #4299e1;
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            background: #4299e1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .btn:hover {
            background: #3182ce;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-success {
            background: #48bb78;
        }

        .btn-export {
            background: #38a169;
        }

        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-5 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #4299e1;
        }

        .stat-card {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .vehicle-card {
            padding: 15px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }

        .vehicle-card:hover {
            border-color: #4299e1;
        }

        .vehicle-card.active {
            border-color: #4299e1;
            background: #e6f3ff;
        }

        .entry-item {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #dee2e6;
        }

        .chart-placeholder {
            text-align: center;
            color: #6c757d;
        }

        .simple-chart {
            width: 100%;
            height: 250px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .chart-bars {
            display: flex;
            align-items: end;
            height: 180px;
            gap: 10px;
            margin-top: 20px;
        }

        .chart-bar {
            background: linear-gradient(to top, #4299e1, #667eea);
            border-radius: 4px 4px 0 0;
            flex: 1;
            min-height: 20px;
            position: relative;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .chart-line {
            position: relative;
            height: 180px;
            margin-top: 20px;
        }

        .chart-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #4299e1;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .analytics-summary {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .insight-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }

        .insight-title {
            font-weight: bold;
            color: #17a2b8;
            margin-bottom: 8px;
        }

        .prediction-card {
            background: #f8f9fa;
            border-left-color: #6f42c1;
        }

        .prediction-card .insight-title {
            color: #6f42c1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .grid-2,
            .grid-3,
            .grid-4,
            .grid-5 {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .quick-filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Vehicle Mileage Calculator</h1>
            <p>Track fuel efficiency, costs, and maintenance with advanced analytics</p>
            <div class="info-box">
                <p><strong>üìã How Mileage Calculation Works:</strong></p>
                <p>‚Ä¢ <strong>Full Tank Method:</strong> Most accurate - calculates between full tank entries</p>
                <p>‚Ä¢ <strong>Running Total Method:</strong> Tracks partial fills between full tanks</p>
                <p>‚Ä¢ <strong>Estimation Method:</strong> Uses tank capacity when no full tanks available</p>
                <p>‚Ä¢ <strong>Mixed Fills OK:</strong> You can mix full and partial fills - the app handles both!</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">üè† Dashboard</button>
            <button class="tab-btn" onclick="showTab('analytics')">üìä Analytics</button>
            <button class="tab-btn" onclick="showTab('vehicles')">üöó Vehicles</button>
            <button class="tab-btn" onclick="showTab('fuel-log')">‚õΩ Fuel Log</button>
            <button class="tab-btn" onclick="showTab('maintenance')">üîß Maintenance</button>
            <button class="tab-btn" onclick="showTab('settings')" style="margin-left: auto; background: #e53e3e; color: white;">‚öôÔ∏è Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div id="vehicle-selector"></div>
            
            <div class="grid grid-4">
                <div class="card stat-card">
                    <div class="stat-value" id="current-mileage">0.0</div>
                    <div>Current Mileage (km/l)</div>
                    <div class="stat-change" id="mileage-method"></div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="avg-mileage">0.0</div>
                    <div>Average Mileage</div>
                    <div class="stat-change" id="accuracy-level"></div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="total-cost">‚Çπ0</div>
                    <div>Total Fuel Cost</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="total-distance">0</div>
                    <div>Total Distance (km)</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h3>Fuel Efficiency Trend</h3>
                    <div class="chart-container">
                        <div id="efficiencyChart" class="simple-chart"></div>
                    </div>
                </div>
                <div class="card">
                    <h3>Monthly Fuel Costs</h3>
                    <div class="chart-container">
                        <div id="costChart" class="simple-chart"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Recent Fuel Entries</h3>
                <div id="recent-entries"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="analytics-filters">
                <h3>üìä Analytics Filters</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Time Period:</label>
                        <select id="time-period" onchange="updateAnalytics()">
                            <option value="all">All Time</option>
                            <option value="current-month">Current Month</option>
                            <option value="last-month">Last Month</option>
                            <option value="current-year">Current Year</option>
                            <option value="last-year">Last Year</option>
                            <option value="last-3-months">Last 3 Months</option>
                            <option value="last-6-months">Last 6 Months</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-group" id="custom-date-range" style="display: none;">
                        <label>From:</label>
                        <input type="date" id="date-from" onchange="updateAnalytics()">
                    </div>
                    <div class="filter-group" id="custom-date-range-to" style="display: none;">
                        <label>To:</label>
                        <input type="date" id="date-to" onchange="updateAnalytics()">
                    </div>
                    <div class="filter-group">
                        <label>Compare With:</label>
                        <select id="comparison-period" onchange="updateAnalytics()">
                            <option value="none">No Comparison</option>
                            <option value="previous-period">Previous Period</option>
                        </select>
                    </div>
                </div>
                <div class="quick-filters">
                    <button class="quick-filter-btn active" onclick="setQuickFilter('all')">All Time</button>
                    <button class="quick-filter-btn" onclick="setQuickFilter('current-month')">This Month</button>
                    <button class="quick-filter-btn" onclick="setQuickFilter('last-month')">Last Month</button>
                    <button class="quick-filter-btn" onclick="setQuickFilter('current-year')">This Year</button>
                    <button class="quick-filter-btn" onclick="setQuickFilter('last-3-months')">Last 3 Months</button>
                    <button class="quick-filter-btn" onclick="setQuickFilter('last-6-months')">Last 6 Months</button>
                </div>
                <button class="btn btn-export" onclick="exportAnalytics()">üìã Export Analytics</button>
            </div>

            <div class="analytics-summary">
                <h3>üìà Analytics Summary</h3>
                <div id="analytics-period-info"></div>
            </div>

            <div class="grid grid-5">
                <div class="card stat-card green">
                    <div class="stat-value" id="period-mileage">0.0</div>
                    <div>Avg Mileage</div>
                    <div class="stat-change" id="mileage-change"></div>
                </div>
                <div class="card stat-card orange">
                    <div class="stat-value" id="period-cost">‚Çπ0</div>
                    <div>Total Cost</div>
                    <div class="stat-change" id="cost-change"></div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="period-distance">0</div>
                    <div>Distance (km)</div>
                    <div class="stat-change" id="distance-change"></div>
                </div>
                <div class="card stat-card red">
                    <div class="stat-value" id="period-cost-per-km">‚Çπ0.0</div>
                    <div>Cost/km</div>
                    <div class="stat-change" id="cost-per-km-change"></div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="period-entries">0</div>
                    <div>Fill-ups</div>
                    <div class="stat-change" id="entries-change"></div>
                </div>
            </div>

            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-title">üí° Best Performance</div>
                    <div id="best-performance-insight"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">‚ö†Ô∏è Areas for Improvement</div>
                    <div id="improvement-insight"></div>
                </div>
                <div class="insight-card prediction-card">
                    <div class="insight-title">üîÆ Predictions</div>
                    <div id="prediction-insight"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">üìä Key Trends</div>
                    <div id="trends-insight"></div>
                </div>
            </div>
        </div>

        <!-- Vehicles Tab -->
        <div id="vehicles" class="tab-content">
            <button class="btn btn-success" onclick="showModal('vehicle-modal')">Add New Vehicle</button>
            <div id="vehicles-list"></div>
        </div>

        <!-- Fuel Log Tab -->
        <div id="fuel-log" class="tab-content">
            <button class="btn btn-success" onclick="showModal('fuel-modal')">Add Fuel Entry</button>
            <div id="fuel-entries"></div>
        </div>

        <!-- Maintenance Tab -->
        <div id="maintenance" class="tab-content">
            <button class="btn btn-success" onclick="showModal('maintenance-modal')">Add Maintenance Record</button>
            <div id="maintenance-records"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3>‚öôÔ∏è App Settings & Data Management</h3>
                
                <div style="margin: 20px 0;">
                    <h4>üìä Data Overview</h4>
                    <div id="data-overview"></div>
                </div>

                <div style="margin: 20px 0;">
                    <h4>üíæ Backup & Export</h4>
                    <button class="btn btn-export" onclick="exportAllData()">üìã Export All Data (JSON)</button>
                    <button class="btn" onclick="showModal('import-modal')">üìÅ Import Data</button>
                </div>

                <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4>‚ö†Ô∏è Danger Zone</h4>
                    <p><strong>Warning:</strong> These actions cannot be undone!</p>
                    <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Reset All Data</button>
                    <button class="btn btn-danger" onclick="resetCurrentVehicle()">üöó Reset Current Vehicle Only</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="vehicle-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Vehicle</h3>
                <button class="close-btn" onclick="hideModal('vehicle-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Vehicle Name</label>
                <input type="text" id="vehicle-name" placeholder="My Car">
            </div>
            <div class="form-group">
                <label>Vehicle Type</label>
                <select id="vehicle-type" onchange="updateFuelOptions()">
                    <option value="car">Car</option>
                    <option value="bike">Bike</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fuel Type</label>
                <select id="fuel-type">
                    <option value="petrol">Petrol</option>
                    <option value="diesel">Diesel</option>
                </select>
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Tank Capacity (L)</label>
                    <input type="number" id="tank-capacity" step="0.1">
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="vehicle-year" min="1990" max="2030">
                </div>
            </div>
            <button class="btn" onclick="addVehicle()">Add Vehicle</button>
        </div>
    </div>

    <!-- Add Fuel Entry Modal -->
    <div id="fuel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Fuel Entry</h3>
                <button class="close-btn" onclick="hideModal('fuel-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="fuel-date">
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Odometer Reading (km)</label>
                    <input type="number" id="odometer" step="0.1">
                </div>
                <div class="form-group">
                    <label>Fuel Quantity (L)</label>
                    <input type="number" id="fuel-quantity" step="0.01">
                </div>
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Price per Liter (‚Çπ)</label>
                    <input type="number" id="fuel-price" step="0.01">
                </div>
                <div class="form-group">
                    <label>Full Tank? (Affects Accuracy)</label>
                    <select id="full-tank">
                        <option value="true">‚úÖ Yes - Full Tank (High Accuracy)</option>
                        <option value="false">‚ö° No - Partial Fill (Medium/Low Accuracy)</option>
                    </select>
                    <small style="color: #666; font-size: 12px;">
                        Full tanks give most accurate mileage. Partial fills are OK too!
                    </small>
                </div>
            </div>
            <div class="form-group">
                <label>Location (Optional)</label>
                <input type="text" id="fuel-location" placeholder="Petrol Pump Name">
            </div>
            <button class="btn" onclick="addFuelEntry()">Add Entry</button>
        </div>
    </div>

    <!-- Add Maintenance Modal -->
    <div id="maintenance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Maintenance Record</h3>
                <button class="close-btn" onclick="hideModal('maintenance-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Maintenance Type</label>
                <select id="maintenance-type">
                    <option value="oil-change">Oil Change</option>
                    <option value="tire-rotation">Tire Rotation</option>
                    <option value="brake-service">Brake Service</option>
                    <option value="engine-service">Engine Service</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="maintenance-date">
                </div>
                <div class="form-group">
                    <label>Odometer (km)</label>
                    <input type="number" id="maintenance-odometer">
                </div>
            </div>
            <div class="form-group">
                <label>Cost (‚Çπ)</label>
                <input type="number" id="maintenance-cost" step="0.01">
            </div>
            <button class="btn" onclick="addMaintenance()">Add Record</button>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Data</h3>
                <button class="close-btn" onclick="hideModal('import-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Select JSON File</label>
                <input type="file" id="import-file" accept=".json">
            </div>
            <div style="margin: 15px 0; padding: 15px; background: #d1ecf1; border-radius: 8px;">
                <p><strong>üìù Note:</strong> Import a JSON file previously exported from this app. This will replace all current data.</p>
            </div>
            <button class="btn" onclick="importData()">Import Data</button>
        </div>
    </div>

    <script>
        var vehicles = [];
        var fuelEntries = [];
        var maintenanceRecords = [];
        var currentVehicle = null;
        var currentAnalyticsPeriod = 'all';
        var currentComparisonPeriod = 'none';

        function loadData() {
            try {
                var savedVehicles = localStorage.getItem('vehicles');
                var savedFuelEntries = localStorage.getItem('fuelEntries');
                var savedMaintenance = localStorage.getItem('maintenanceRecords');

                if (savedVehicles) vehicles = JSON.parse(savedVehicles);
                if (savedFuelEntries) fuelEntries = JSON.parse(savedFuelEntries);
                if (savedMaintenance) maintenanceRecords = JSON.parse(savedMaintenance);

                if (vehicles.length > 0 && !currentVehicle) {
                    currentVehicle = vehicles[0];
                }
            } catch (e) {
                console.log('Error loading data');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                localStorage.setItem('fuelEntries', JSON.stringify(fuelEntries));
                localStorage.setItem('maintenanceRecords', JSON.stringify(maintenanceRecords));
            } catch (e) {
                console.log('Error saving data');
            }
        }

        function showTab(tabName) {
            var tabs = document.querySelectorAll('.tab-content');
            var buttons = document.querySelectorAll('.tab-btn');
            
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'settings') {
                updateDataOverview();
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            setTodayDate();
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function setTodayDate() {
            var today = new Date();
            var year = today.getFullYear();
            var month = (today.getMonth() + 1).toString();
            var day = today.getDate().toString();
            
            if (month.length === 1) month = '0' + month;
            if (day.length === 1) day = '0' + day;
            
            var dateStr = year + '-' + month + '-' + day;
            
            var fuelDate = document.getElementById('fuel-date');
            var maintenanceDate = document.getElementById('maintenance-date');
            
            if (fuelDate) fuelDate.value = dateStr;
            if (maintenanceDate) maintenanceDate.value = dateStr;
        }

        function updateFuelOptions() {
            var vehicleType = document.getElementById('vehicle-type').value;
            var fuelType = document.getElementById('fuel-type');
            
            fuelType.innerHTML = '';
            if (vehicleType === 'bike') {
                fuelType.innerHTML = '<option value="petrol">Petrol</option>';
            } else {
                fuelType.innerHTML = '<option value="petrol">Petrol</option><option value="diesel">Diesel</option>';
            }
        }

        function addVehicle() {
            var name = document.getElementById('vehicle-name').value;
            var type = document.getElementById('vehicle-type').value;
            var fuelType = document.getElementById('fuel-type').value;
            var tankCapacity = document.getElementById('tank-capacity').value;
            var year = document.getElementById('vehicle-year').value;

            if (!name || !tankCapacity) {
                alert('Please fill all required fields');
                return;
            }

            var vehicle = {
                id: Date.now(),
                name: name,
                type: type,
                fuelType: fuelType,
                tankCapacity: parseFloat(tankCapacity),
                year: parseInt(year) || new Date().getFullYear()
            };

            vehicles.push(vehicle);
            if (!currentVehicle) currentVehicle = vehicle;

            document.getElementById('vehicle-name').value = '';
            document.getElementById('tank-capacity').value = '';
            document.getElementById('vehicle-year').value = '';

            saveData();
            updateDisplay();
            hideModal('vehicle-modal');
        }

        function addFuelEntry() {
            if (!currentVehicle) {
                alert('Please add a vehicle first');
                return;
            }

            var date = document.getElementById('fuel-date').value;
            var odometer = document.getElementById('odometer').value;
            var quantity = document.getElementById('fuel-quantity').value;
            var price = document.getElementById('fuel-price').value;
            var fullTank = document.getElementById('full-tank').value === 'true';
            var location = document.getElementById('fuel-location').value;

            if (!date || !odometer || !quantity || !price) {
                alert('Please fill all required fields');
                return;
            }

            var entry = {
                id: Date.now(),
                vehicleId: currentVehicle.id,
                date: date,
                odometer: parseFloat(odometer),
                quantity: parseFloat(quantity),
                price: parseFloat(price),
                fullTank: fullTank,
                location: location,
                totalCost: parseFloat(quantity) * parseFloat(price)
            };

            fuelEntries.push(entry);
            fuelEntries.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });

            document.getElementById('fuel-date').value = '';
            document.getElementById('odometer').value = '';
            document.getElementById('fuel-quantity').value = '';
            document.getElementById('fuel-price').value = '';
            document.getElementById('fuel-location').value = '';

            saveData();
            updateDisplay();
            hideModal('fuel-modal');
        }

        function addMaintenance() {
            if (!currentVehicle) {
                alert('Please add a vehicle first');
                return;
            }

            var type = document.getElementById('maintenance-type').value;
            var date = document.getElementById('maintenance-date').value;
            var odometer = document.getElementById('maintenance-odometer').value;
            var cost = document.getElementById('maintenance-cost').value;

            if (!date || !odometer) {
                alert('Please fill all required fields');
                return;
            }

            var record = {
                id: Date.now(),
                vehicleId: currentVehicle.id,
                type: type,
                date: date,
                odometer: parseFloat(odometer),
                cost: parseFloat(cost) || 0
            };

            maintenanceRecords.push(record);
            maintenanceRecords.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });

            document.getElementById('maintenance-date').value = '';
            document.getElementById('maintenance-odometer').value = '';
            document.getElementById('maintenance-cost').value = '';

            saveData();
            updateDisplay();
            hideModal('maintenance-modal');
        }

        function selectVehicle(vehicleId) {
            for (var i = 0; i < vehicles.length; i++) {
                if (vehicles[i].id === vehicleId) {
                    currentVehicle = vehicles[i];
                    break;
                }
            }
            updateDisplay();
        }

        function deleteVehicle(vehicleId) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                vehicles = vehicles.filter(function(v) { return v.id !== vehicleId; });
                fuelEntries = fuelEntries.filter(function(e) { return e.vehicleId !== vehicleId; });
                maintenanceRecords = maintenanceRecords.filter(function(r) { return r.vehicleId !== vehicleId; });
                
                if (currentVehicle && currentVehicle.id === vehicleId) {
                    currentVehicle = vehicles.length > 0 ? vehicles[0] : null;
                }
                
                saveData();
                updateDisplay();
            }
        }

        function deleteFuelEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                fuelEntries = fuelEntries.filter(function(e) { return e.id !== entryId; });
                saveData();
                updateDisplay();
            }
        }

        function deleteMaintenance(recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
                maintenanceRecords = maintenanceRecords.filter(function(r) { return r.id !== recordId; });
                saveData();
                updateDisplay();
            }
        }

        function calculateStats() {
            if (!currentVehicle) return { current: 0, average: 0, totalCost: 0, totalDistance: 0, hasEnoughData: false, totalEntries: 0, method: 'none' };

            var allEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });
            var fullTankEntries = fuelEntries.filter(function(e) { 
                return e.vehicleId === currentVehicle.id && e.fullTank; 
            });

            var totalCost = 0;
            for (var i = 0; i < allEntries.length; i++) {
                totalCost += allEntries[i].totalCost;
            }

            // Need at least 2 entries total for any calculation
            if (allEntries.length < 2) {
                return { 
                    current: 0, 
                    average: 0, 
                    totalCost: totalCost, 
                    totalDistance: 0, 
                    hasEnoughData: false,
                    totalEntries: allEntries.length,
                    fullTankEntries: fullTankEntries.length,
                    method: 'insufficient'
                };
            }

            // Method 1: Full-to-Full (Most Accurate)
            if (fullTankEntries.length >= 2) {
                return calculateFullToFullMileage(fullTankEntries, allEntries, totalCost);
            }

            // Method 2: Running Total (Partial fills between full tanks)
            if (fullTankEntries.length === 1) {
                return calculateRunningTotalMileage(allEntries, totalCost);
            }

            // Method 3: Estimation (No full tanks)
            if (allEntries.length >= 2) {
                return calculateEstimatedMileage(allEntries, totalCost);
            }

            return { 
                current: 0, 
                average: 0, 
                totalCost: totalCost, 
                totalDistance: 0, 
                hasEnoughData: false,
                totalEntries: allEntries.length,
                fullTankEntries: fullTankEntries.length,
                method: 'insufficient'
            };
        }

        // Method 1: Full-to-Full calculation (Most Accurate)
        function calculateFullToFullMileage(fullTankEntries, allEntries, totalCost) {
            var totalMileage = 0;
            var validEntries = 0;
            var totalDistance = 0;
            var currentMileage = 0;

            for (var i = 1; i < fullTankEntries.length; i++) {
                var distance = fullTankEntries[i].odometer - fullTankEntries[i-1].odometer;
                var fuel = fullTankEntries[i].quantity;

                if (distance > 0 && fuel > 0) {
                    var mileage = distance / fuel;
                    totalMileage += mileage;
                    validEntries++;
                    totalDistance += distance;

                    if (i === fullTankEntries.length - 1) {
                        currentMileage = mileage;
                    }
                }
            }

            return {
                current: currentMileage,
                average: validEntries > 0 ? totalMileage / validEntries : 0,
                totalCost: totalCost,
                totalDistance: totalDistance,
                hasEnoughData: true,
                totalEntries: allEntries.length,
                fullTankEntries: fullTankEntries.length,
                method: 'full-to-full',
                accuracy: 'high'
            };
        }

        // Method 2: Running Total (Mixed fills)
        function calculateRunningTotalMileage(allEntries, totalCost) {
            // Find the full tank entry
            var fullTankIndex = -1;
            for (var i = 0; i < allEntries.length; i++) {
                if (allEntries[i].fullTank) {
                    fullTankIndex = i;
                    break;
                }
            }

            if (fullTankIndex === -1 || fullTankIndex === allEntries.length - 1) {
                return calculateEstimatedMileage(allEntries, totalCost);
            }

            // Calculate from full tank to latest entry
            var startEntry = allEntries[fullTankIndex];
            var endEntry = allEntries[allEntries.length - 1];
            
            // Sum all fuel added after the full tank
            var totalFuelAdded = 0;
            for (var i = fullTankIndex + 1; i < allEntries.length; i++) {
                totalFuelAdded += allEntries[i].quantity;
            }

            var distance = endEntry.odometer - startEntry.odometer;
            var currentMileage = distance > 0 && totalFuelAdded > 0 ? distance / totalFuelAdded : 0;

            return {
                current: currentMileage,
                average: currentMileage, // Only one data point
                totalCost: totalCost,
                totalDistance: distance,
                hasEnoughData: true,
                totalEntries: allEntries.length,
                fullTankEntries: 1,
                method: 'running-total',
                accuracy: 'medium'
            };
        }

        // Method 3: Estimation (No full tanks)
        function calculateEstimatedMileage(allEntries, totalCost) {
            if (!currentVehicle || !currentVehicle.tankCapacity) {
                return {
                    current: 0,
                    average: 0,
                    totalCost: totalCost,
                    totalDistance: 0,
                    hasEnoughData: false,
                    totalEntries: allEntries.length,
                    fullTankEntries: 0,
                    method: 'estimation',
                    accuracy: 'low'
                };
            }

            // Use most recent entries for estimation
            var recent = allEntries.slice(-2);
            var distance = recent[1].odometer - recent[0].odometer;
            var fuelAdded = recent[1].quantity;
            
            // Estimate based on partial fill and tank capacity
            var estimatedMileage = 0;
            if (distance > 0 && fuelAdded > 0) {
                // Simple estimation: assume fuel added represents same proportion of distance
                estimatedMileage = distance / fuelAdded;
            }

            var totalDistance = allEntries[allEntries.length - 1].odometer - allEntries[0].odometer;

            return {
                current: estimatedMileage,
                average: estimatedMileage,
                totalCost: totalCost,
                totalDistance: totalDistance,
                hasEnoughData: estimatedMileage > 0,
                totalEntries: allEntries.length,
                fullTankEntries: 0,
                method: 'estimation',
                accuracy: 'low'
            };
        }

        function updateDisplay() {
            updateVehicleSelector();
            updateDashboard();
            updateVehiclesList();
            updateFuelLog();
            updateMaintenanceLog();
            updateCharts();
        }

        function updateVehicleSelector() {
            var selector = document.getElementById('vehicle-selector');
            if (!selector) return;

            var html = '<h3>Select Vehicle:</h3>';
            for (var i = 0; i < vehicles.length; i++) {
                var vehicle = vehicles[i];
                var isActive = currentVehicle && currentVehicle.id === vehicle.id;
                html += '<div class="vehicle-card' + (isActive ? ' active' : '') + '" onclick="selectVehicle(' + vehicle.id + ')">';
                html += '<strong>' + vehicle.name + '</strong><br>';
                html += '<small>' + vehicle.type.toUpperCase() + ' - ' + vehicle.fuelType.toUpperCase() + '</small>';
                html += '</div>';
            }

            if (vehicles.length === 0) {
                html += '<p>No vehicles added yet. Add your first vehicle!</p>';
            }

            selector.innerHTML = html;
        }

        function updateDashboard() {
            var stats = calculateStats();

            var currentMileageEl = document.getElementById('current-mileage');
            var avgMileageEl = document.getElementById('avg-mileage');
            var totalCostEl = document.getElementById('total-cost');
            var totalDistanceEl = document.getElementById('total-distance');
            var mileageMethodEl = document.getElementById('mileage-method');
            var accuracyLevelEl = document.getElementById('accuracy-level');

            if (stats.hasEnoughData) {
                if (currentMileageEl) currentMileageEl.textContent = stats.current.toFixed(1);
                if (avgMileageEl) avgMileageEl.textContent = stats.average.toFixed(1);
                if (totalDistanceEl) totalDistanceEl.textContent = stats.totalDistance.toFixed(0);
                
                // Show method and accuracy
                if (mileageMethodEl) {
                    var methodText = '';
                    switch (stats.method) {
                        case 'full-to-full': methodText = 'üéØ Full Tank Method'; break;
                        case 'running-total': methodText = 'üìä Mixed Fill Method'; break;
                        case 'estimation': methodText = 'üìà Estimated Method'; break;
                    }
                    mileageMethodEl.textContent = methodText;
                }
                
                if (accuracyLevelEl) {
                    var accuracyText = '';
                    var accuracyClass = '';
                    switch (stats.accuracy) {
                        case 'high': 
                            accuracyText = '‚úÖ High Accuracy'; 
                            accuracyClass = 'trend-up';
                            break;
                        case 'medium': 
                            accuracyText = '‚ö° Medium Accuracy'; 
                            accuracyClass = '';
                            break;
                        case 'low': 
                            accuracyText = '‚ö†Ô∏è Low Accuracy'; 
                            accuracyClass = 'trend-down';
                            break;
                    }
                    accuracyLevelEl.textContent = accuracyText;
                    accuracyLevelEl.className = 'stat-change ' + accuracyClass;
                }
            } else {
                if (currentMileageEl) currentMileageEl.textContent = '--';
                if (avgMileageEl) avgMileageEl.textContent = '--';
                if (totalDistanceEl) totalDistanceEl.textContent = '--';
                if (mileageMethodEl) mileageMethodEl.textContent = 'Need more data';
                if (accuracyLevelEl) accuracyLevelEl.textContent = 'Add fuel entries';
            }

            if (totalCostEl) totalCostEl.textContent = '‚Çπ' + stats.totalCost.toFixed(0);

            updateDataStatusMessage();
        }

        function updateDataStatusMessage() {
            var container = document.getElementById('recent-entries');
            if (!container || !currentVehicle) return;

            var stats = calculateStats();
            var vehicleEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });
            
            if (vehicleEntries.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><strong>üìù Get Started:</strong><br>Add your first fuel entry to begin tracking!</div>';
                return;
            }

            var message = '';
            var alertType = 'info';

            switch (stats.method) {
                case 'insufficient':
                    if (stats.totalEntries === 1) {
                        message = '<div class="alert alert-info"><strong>üìä One Entry Added:</strong><br>Add your next fuel entry (full or partial) to start seeing mileage calculations!<br><small>Tip: Full tank entries give more accurate results</small></div>';
                    } else {
                        message = '<div class="alert alert-warning"><strong>‚ö†Ô∏è Need More Data:</strong><br>Add more fuel entries to calculate mileage.</div>';
                    }
                    break;

                case 'full-to-full':
                    alertType = 'success';
                    message = '<div class="alert alert-success"><strong>‚úÖ High Accuracy Tracking:</strong><br>Mileage calculated using ' + stats.fullTankEntries + ' full tank entries (Full-to-Full method)<br><small>Accuracy: ' + stats.accuracy.toUpperCase() + ' ‚Ä¢ Most reliable method</small></div>';
                    break;

                case 'running-total':
                    alertType = 'info';
                    message = '<div class="alert alert-info"><strong>üìä Mixed Fill Tracking:</strong><br>Mileage calculated from your full tank + partial fills (Running Total method)<br><small>Accuracy: ' + stats.accuracy.toUpperCase() + ' ‚Ä¢ ' + stats.totalEntries + ' total entries, ' + stats.fullTankEntries + ' full tank</small></div>';
                    break;

                case 'estimation':
                    alertType = 'warning';
                    message = '<div class="alert alert-warning"><strong>üìà Estimated Tracking:</strong><br>Mileage estimated from partial fills only (Estimation method)<br><small>Accuracy: ' + stats.accuracy.toUpperCase() + ' ‚Ä¢ Add a full tank entry for better accuracy</small></div>';
                    break;

                default:
                    message = '<div class="alert alert-info"><strong>üìù Ready to Track:</strong><br>Add fuel entries to see mileage calculations.</div>';
            }
            
            container.innerHTML = message + '<div style="margin-top: 15px;">' + getRecentEntriesHTML() + '</div>';
        }

        function getRecentEntriesHTML() {
            if (!currentVehicle) return '';

            var vehicleEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });
            var recentEntries = vehicleEntries.slice(-5).reverse();

            if (recentEntries.length === 0) {
                return '<p>No fuel entries found.</p>';
            }

            var html = '<h4>Recent Entries:</h4>';
            for (var i = 0; i < recentEntries.length; i++) {
                var entry = recentEntries[i];
                var fullTankIcon = entry.fullTank ? '‚õΩ' : 'üöó';
                html += '<div class="entry-item">';
                html += '<div>';
                html += '<strong>' + fullTankIcon + ' ' + new Date(entry.date).toLocaleDateString() + '</strong><br>';
                html += '<small>' + entry.quantity + 'L @ ‚Çπ' + entry.price + '/L = ‚Çπ' + entry.totalCost.toFixed(2) + '</small><br>';
                html += '<small>Odometer: ' + entry.odometer + ' km ‚Ä¢ ' + (entry.fullTank ? 'Full Tank' : 'Partial Fill') + '</small>';
                html += '</div>';
                html += '</div>';
            }
            return html;
        }

        function updateVehiclesList() {
            var container = document.getElementById('vehicles-list');
            if (!container) return;

            if (vehicles.length === 0) {
                container.innerHTML = '<p>No vehicles added yet.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < vehicles.length; i++) {
                var vehicle = vehicles[i];
                var vehicleEntries = fuelEntries.filter(function(e) { return e.vehicleId === vehicle.id; });
                
                html += '<div class="card">';
                html += '<h4>' + vehicle.name + '</h4>';
                html += '<p><strong>Type:</strong> ' + vehicle.type.toUpperCase() + '</p>';
                html += '<p><strong>Fuel:</strong> ' + vehicle.fuelType.toUpperCase() + '</p>';
                html += '<p><strong>Tank:</strong> ' + vehicle.tankCapacity + 'L</p>';
                html += '<p><strong>Year:</strong> ' + vehicle.year + '</p>';
                html += '<p><strong>Entries:</strong> ' + vehicleEntries.length + '</p>';
                html += '<button class="btn btn-danger" onclick="deleteVehicle(' + vehicle.id + ')">Delete</button>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function updateFuelLog() {
            var container = document.getElementById('fuel-entries');
            if (!container || !currentVehicle) return;

            var vehicleEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });
            vehicleEntries.reverse();

            if (vehicleEntries.length === 0) {
                container.innerHTML = '<p>No fuel entries found.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < vehicleEntries.length; i++) {
                var entry = vehicleEntries[i];
                var fullTankIcon = entry.fullTank ? '‚õΩ' : 'üöó';
                html += '<div class="entry-item">';
                html += '<div>';
                html += '<strong>' + fullTankIcon + ' ' + new Date(entry.date).toLocaleDateString() + '</strong><br>';
                html += 'Odometer: ' + entry.odometer + ' km<br>';
                html += 'Fuel: ' + entry.quantity + 'L @ ‚Çπ' + entry.price + '/L<br>';
                html += 'Cost: ‚Çπ' + entry.totalCost.toFixed(2) + '<br>';
                html += 'Full Tank: ' + (entry.fullTank ? 'Yes' : 'No');
                if (entry.location) html += '<br>Location: ' + entry.location;
                html += '</div>';
                html += '<button class="btn btn-danger" onclick="deleteFuelEntry(' + entry.id + ')">üóëÔ∏è Delete</button>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function updateMaintenanceLog() {
            var container = document.getElementById('maintenance-records');
            if (!container || !currentVehicle) return;

            var vehicleRecords = maintenanceRecords.filter(function(r) { return r.vehicleId === currentVehicle.id; });

            if (vehicleRecords.length === 0) {
                container.innerHTML = '<p>No maintenance records found.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < vehicleRecords.length; i++) {
                var record = vehicleRecords[i];
                html += '<div class="entry-item">';
                html += '<div>';
                html += '<strong>' + record.type.replace('-', ' ').toUpperCase() + '</strong><br>';
                html += 'Date: ' + new Date(record.date).toLocaleDateString() + '<br>';
                html += 'Odometer: ' + record.odometer + ' km<br>';
                html += 'Cost: ‚Çπ' + record.cost.toFixed(2);
                html += '</div>';
                html += '<button class="btn btn-danger" onclick="deleteMaintenance(' + record.id + ')">Delete</button>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function updateCharts() {
            updateSimpleEfficiencyChart();
            updateSimpleCostChart();
        }

        function updateSimpleEfficiencyChart() {
            var container = document.getElementById('efficiencyChart');
            if (!container || !currentVehicle) return;

            var vehicleEntries = fuelEntries.filter(function(e) { 
                return e.vehicleId === currentVehicle.id && e.fullTank; 
            });

            if (vehicleEntries.length < 2) {
                container.innerHTML = '<div class="chart-placeholder">üìä<br>Add more fuel entries<br>to see efficiency trends</div>';
                return;
            }

            var mileageData = [];
            for (var i = 1; i < vehicleEntries.length; i++) {
                var distance = vehicleEntries[i].odometer - vehicleEntries[i-1].odometer;
                var fuel = vehicleEntries[i].quantity;
                if (distance > 0 && fuel > 0) {
                    mileageData.push({
                        date: vehicleEntries[i].date,
                        mileage: distance / fuel
                    });
                }
            }

            if (mileageData.length === 0) {
                container.innerHTML = '<div class="chart-placeholder">üìä<br>No mileage data<br>available</div>';
                return;
            }

            var html = '<h4>Mileage Trend</h4><div class="chart-line">';
            var maxMileage = Math.max.apply(Math, mileageData.map(function(d) { return d.mileage; }));
            
            for (var i = 0; i < mileageData.length; i++) {
                var data = mileageData[i];
                var height = (data.mileage / maxMileage) * 150;
                var left = (i / (mileageData.length - 1)) * 90;
                
                html += '<div class="chart-point" style="bottom: ' + height + 'px; left: ' + left + '%" title="' + data.mileage.toFixed(1) + ' km/l"></div>';
            }
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateSimpleCostChart() {
            var container = document.getElementById('costChart');
            if (!container || !currentVehicle) return;

            var vehicleEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });

            if (vehicleEntries.length === 0) {
                container.innerHTML = '<div class="chart-placeholder">üí∞<br>Add fuel entries<br>to see cost trends</div>';
                return;
            }

            var monthlyData = {};
            for (var i = 0; i < vehicleEntries.length; i++) {
                var entry = vehicleEntries[i];
                var month = new Date(entry.date).toISOString().slice(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + entry.totalCost;
            }

            var months = Object.keys(monthlyData).sort().slice(-6);
            if (months.length === 0) {
                container.innerHTML = '<div class="chart-placeholder">üí∞<br>No cost data<br>available</div>';
                return;
            }

            var maxCost = Math.max.apply(Math, months.map(function(m) { return monthlyData[m]; }));
            
            var html = '<h4>Monthly Costs</h4><div class="chart-bars">';
            for (var i = 0; i < months.length; i++) {
                var month = months[i];
                var cost = monthlyData[month];
                var height = (cost / maxCost) * 150;
                
                html += '<div class="chart-bar" style="height: ' + height + 'px" title="‚Çπ' + cost.toFixed(0) + '">';
                html += '‚Çπ' + cost.toFixed(0);
                html += '</div>';
            }
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Analytics functions (simplified)
        function getDateRange(period) {
            var now = new Date();
            var startDate, endDate;

            switch (period) {
                case 'current-month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'current-year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'last-year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                case 'last-3-months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    endDate = now;
                    break;
                case 'last-6-months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    endDate = now;
                    break;
                case 'custom':
                    var fromDate = document.getElementById('date-from').value;
                    var toDate = document.getElementById('date-to').value;
                    if (fromDate && toDate) {
                        startDate = new Date(fromDate);
                        endDate = new Date(toDate);
                    } else {
                        return null;
                    }
                    break;
                default:
                    return null;
            }

            return { start: startDate, end: endDate };
        }

        function filterEntriesByDateRange(entries, dateRange) {
            if (!dateRange) return entries;
            
            return entries.filter(function(entry) {
                var entryDate = new Date(entry.date);
                return entryDate >= dateRange.start && entryDate <= dateRange.end;
            });
        }

        function calculatePeriodStats(period) {
            if (!currentVehicle) return { mileage: 0, cost: 0, distance: 0, costPerKm: 0, entries: 0, hasEnoughData: false };

            var dateRange = getDateRange(period);
            var vehicleEntries = fuelEntries.filter(function(e) { 
                return e.vehicleId === currentVehicle.id && e.fullTank; 
            });

            if (dateRange) {
                vehicleEntries = filterEntriesByDateRange(vehicleEntries, dateRange);
            }

            var allPeriodEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });
            if (dateRange) {
                allPeriodEntries = filterEntriesByDateRange(allPeriodEntries, dateRange);
            }

            var totalCost = 0;
            for (var i = 0; i < allPeriodEntries.length; i++) {
                totalCost += allPeriodEntries[i].totalCost;
            }

            if (vehicleEntries.length < 2) {
                return { 
                    mileage: 0, 
                    cost: totalCost, 
                    distance: 0, 
                    costPerKm: 0, 
                    entries: allPeriodEntries.length,
                    hasEnoughData: false,
                    fullTankEntries: vehicleEntries.length
                };
            }

            var totalMileage = 0;
            var validEntries = 0;
            var totalDistance = 0;

            for (var i = 1; i < vehicleEntries.length; i++) {
                var distance = vehicleEntries[i].odometer - vehicleEntries[i-1].odometer;
                var fuel = vehicleEntries[i].quantity;

                if (distance > 0 && fuel > 0) {
                    var mileage = distance / fuel;
                    totalMileage += mileage;
                    validEntries++;
                    totalDistance += distance;
                }
            }

            return {
                mileage: validEntries > 0 ? totalMileage / validEntries : 0,
                cost: totalCost,
                distance: totalDistance,
                costPerKm: totalDistance > 0 ? totalCost / totalDistance : 0,
                entries: allPeriodEntries.length,
                hasEnoughData: true,
                fullTankEntries: vehicleEntries.length
            };
        }

        function setQuickFilter(period) {
            document.getElementById('time-period').value = period;
            currentAnalyticsPeriod = period;
            
            var buttons = document.querySelectorAll('.quick-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            event.target.classList.add('active');

            var customRange = document.getElementById('custom-date-range');
            var customRangeTo = document.getElementById('custom-date-range-to');
            if (period === 'custom') {
                customRange.style.display = 'block';
                customRangeTo.style.display = 'block';
            } else {
                customRange.style.display = 'none';
                customRangeTo.style.display = 'none';
            }

            updateAnalytics();
        }

        function updateAnalytics() {
            currentAnalyticsPeriod = document.getElementById('time-period').value;
            currentComparisonPeriod = document.getElementById('comparison-period').value;

            var customRange = document.getElementById('custom-date-range');
            var customRangeTo = document.getElementById('custom-date-range-to');
            if (currentAnalyticsPeriod === 'custom') {
                customRange.style.display = 'block';
                customRangeTo.style.display = 'block';
            } else {
                customRange.style.display = 'none';
                customRangeTo.style.display = 'none';
            }

            updateAnalyticsPeriodInfo();
            updateAnalyticsStats();
            updateInsights();
        }

        function updateAnalyticsPeriodInfo() {
            var container = document.getElementById('analytics-period-info');
            if (!container || !currentVehicle) return;

            var periodText = '';
            var dateRange = getDateRange(currentAnalyticsPeriod);
            
            if (dateRange) {
                periodText = 'Period: ' + dateRange.start.toLocaleDateString() + ' to ' + dateRange.end.toLocaleDateString();
            } else {
                periodText = 'Period: All Time';
            }

            container.innerHTML = '<p><strong>' + currentVehicle.name + '</strong> - ' + periodText + '</p>';
        }

        function updateAnalyticsStats() {
            var currentStats = calculatePeriodStats(currentAnalyticsPeriod);

            var elements = {
                'period-mileage': currentStats.hasEnoughData ? currentStats.mileage.toFixed(1) : '--',
                'period-cost': '‚Çπ' + currentStats.cost.toFixed(0),
                'period-distance': currentStats.hasEnoughData ? currentStats.distance.toFixed(0) : '--',
                'period-cost-per-km': currentStats.hasEnoughData ? '‚Çπ' + currentStats.costPerKm.toFixed(2) : '--',
                'period-entries': currentStats.entries
            };

            for (var id in elements) {
                var element = document.getElementById(id);
                if (element) element.textContent = elements[id];
            }

            var changeElements = ['mileage-change', 'cost-change', 'distance-change', 'cost-per-km-change', 'entries-change'];
            for (var i = 0; i < changeElements.length; i++) {
                var element = document.getElementById(changeElements[i]);
                if (element) {
                    if (!currentStats.hasEnoughData) {
                        element.textContent = 'Need more data';
                        element.className = 'stat-change';
                    } else {
                        element.textContent = '';
                    }
                }
            }
        }

        function updateInsights() {
            var bestPerformance = document.getElementById('best-performance-insight');
            var improvement = document.getElementById('improvement-insight');
            var prediction = document.getElementById('prediction-insight');
            var trends = document.getElementById('trends-insight');

            if (!currentVehicle) {
                if (bestPerformance) bestPerformance.innerHTML = 'Please select a vehicle first.';
                if (improvement) improvement.innerHTML = 'Please select a vehicle first.';
                if (prediction) prediction.innerHTML = 'Please select a vehicle first.';
                if (trends) trends.innerHTML = 'Please select a vehicle first.';
                return;
            }

            var stats = calculatePeriodStats(currentAnalyticsPeriod);
            var allTimeStats = calculatePeriodStats('all');

            if (bestPerformance) {
                if (stats.hasEnoughData && stats.mileage > 0) {
                    bestPerformance.innerHTML = 'Average mileage of ' + stats.mileage.toFixed(1) + ' km/l with ' + stats.fullTankEntries + ' full tank entries. Total distance covered: ' + stats.distance.toFixed(0) + ' km.';
                } else if (stats.entries > 0) {
                    var message = 'You have ' + stats.entries + ' fuel entries';
                    if (stats.fullTankEntries > 0) {
                        message += ' (' + stats.fullTankEntries + ' full tank)';
                    }
                    message += '. Add ' + (2 - stats.fullTankEntries) + ' more full tank entries to calculate mileage.';
                    bestPerformance.innerHTML = message;
                } else {
                    bestPerformance.innerHTML = 'Add fuel entries to see performance insights.';
                }
            }

            if (improvement) {
                if (stats.hasEnoughData && stats.costPerKm > 0) {
                    improvement.innerHTML = 'Current cost per km is ‚Çπ' + stats.costPerKm.toFixed(2) + '. Monitor fuel prices and driving patterns to optimize costs.';
                } else if (stats.cost > 0) {
                    improvement.innerHTML = 'Total fuel cost: ‚Çπ' + stats.cost.toFixed(0) + '. Add more full tank entries to track cost efficiency per km.';
                } else {
                    improvement.innerHTML = 'Add fuel entries to get improvement suggestions.';
                }
            }

            if (prediction) {
                if (stats.hasEnoughData && stats.entries > 2) {
                    var avgCostPerMonth = stats.cost / Math.max(1, stats.entries / 4);
                    prediction.innerHTML = 'Based on current pattern, estimated monthly fuel cost: ‚Çπ' + avgCostPerMonth.toFixed(0);
                } else if (stats.entries > 0) {
                    prediction.innerHTML = 'Need at least 2 full tank entries for predictions. Current entries: ' + stats.entries + ' total, ' + stats.fullTankEntries + ' full tank.';
                } else {
                    prediction.innerHTML = 'Add fuel entries for predictions.';
                }
            }

            if (trends) {
                if (allTimeStats.entries > 0 && stats.entries > 0) {
                    var percentage = ((stats.entries / allTimeStats.entries) * 100).toFixed(1);
                    trends.innerHTML = 'Selected period represents ' + percentage + '% of total entries (' + stats.entries + ' out of ' + allTimeStats.entries + ').';
                } else {
                    trends.innerHTML = 'No data available for trend analysis.';
                }
            }
        }

        function exportAnalytics() {
            if (!currentVehicle) {
                alert('Please select a vehicle first');
                return;
            }

            var dateRange = getDateRange(currentAnalyticsPeriod);
            var vehicleEntries = fuelEntries.filter(function(e) { return e.vehicleId === currentVehicle.id; });

            if (dateRange) {
                vehicleEntries = filterEntriesByDateRange(vehicleEntries, dateRange);
            }

            var stats = calculatePeriodStats(currentAnalyticsPeriod);
            var csvContent = "data:text/csv;charset=utf-8,";

            csvContent += "Vehicle Analytics Report\n";
            csvContent += "Vehicle," + currentVehicle.name + "\n";
            csvContent += "Period," + (dateRange ? dateRange.start.toLocaleDateString() + " to " + dateRange.end.toLocaleDateString() : "All Time") + "\n";
            
            if (stats.hasEnoughData) {
                csvContent += "Average Mileage," + stats.mileage.toFixed(1) + " km/l\n";
                csvContent += "Total Distance," + stats.distance.toFixed(0) + " km\n";
                csvContent += "Cost per KM,‚Çπ" + stats.costPerKm.toFixed(2) + "\n";
            } else {
                csvContent += "Average Mileage,Need more data\n";
                csvContent += "Total Distance,Need more data\n";
                csvContent += "Cost per KM,Need more data\n";
            }
            
            csvContent += "Total Cost,‚Çπ" + stats.cost.toFixed(2) + "\n";
            csvContent += "Total Fill-ups," + stats.entries + "\n\n";

            csvContent += "Date,Odometer,Fuel Quantity,Price per Liter,Total Cost,Location\n";
            for (var i = 0; i < vehicleEntries.length; i++) {
                var entry = vehicleEntries[i];
                csvContent += entry.date + "," + entry.odometer + "," + entry.quantity + "," + entry.price + "," + entry.totalCost.toFixed(2) + "," + (entry.location || "") + "\n";
            }

            downloadFile(csvContent, "mileage_analytics_" + currentVehicle.name.replace(/\s+/g, '_') + "_" + new Date().toISOString().slice(0, 10) + ".csv", "text/csv");
        }

        // Settings and Data Management Functions
        function updateDataOverview() {
            var container = document.getElementById('data-overview');
            if (!container) return;

            var totalVehicles = vehicles.length;
            var totalFuelEntries = fuelEntries.length;
            var totalMaintenanceRecords = maintenanceRecords.length;
            var totalCost = 0;

            for (var i = 0; i < fuelEntries.length; i++) {
                totalCost += fuelEntries[i].totalCost;
            }

            var html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">';
            html += '<div class="card" style="text-align: center; border-left-color: #4299e1;"><strong>' + totalVehicles + '</strong><br>Vehicles</div>';
            html += '<div class="card" style="text-align: center; border-left-color: #48bb78;"><strong>' + totalFuelEntries + '</strong><br>Fuel Entries</div>';
            html += '<div class="card" style="text-align: center; border-left-color: #ed8936;"><strong>' + totalMaintenanceRecords + '</strong><br>Maintenance Records</div>';
            html += '<div class="card" style="text-align: center; border-left-color: #e53e3e;"><strong>‚Çπ' + totalCost.toFixed(0) + '</strong><br>Total Fuel Cost</div>';
            html += '</div>';

            if (totalVehicles === 0) {
                html += '<div class="alert alert-info" style="margin-top: 15px;">No data found. Start by adding your first vehicle!</div>';
            }

            container.innerHTML = html;
        }

        function exportAllData() {
            var allData = {
                vehicles: vehicles,
                fuelEntries: fuelEntries,
                maintenanceRecords: maintenanceRecords,
                exportDate: new Date().toISOString(),
                version: "1.0"
            };

            var jsonContent = JSON.stringify(allData, null, 2);
            var dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(jsonContent);
            
            downloadFile(dataUri, "mileage_calculator_backup_" + new Date().toISOString().slice(0, 10) + ".json", "application/json");
        }

        function importData() {
            var fileInput = document.getElementById('import-file');
            var file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var importedData = JSON.parse(e.target.result);
                    
                    if (importedData.vehicles && importedData.fuelEntries && importedData.maintenanceRecords) {
                        if (confirm('This will replace all current data. Are you sure you want to continue?')) {
                            vehicles = importedData.vehicles;
                            fuelEntries = importedData.fuelEntries;
                            maintenanceRecords = importedData.maintenanceRecords;
                            
                            currentVehicle = vehicles.length > 0 ? vehicles[0] : null;
                            
                            saveData();
                            updateDisplay();
                            updateDataOverview();
                            hideModal('import-modal');
                            
                            alert('Data imported successfully! Imported: ' + vehicles.length + ' vehicles, ' + fuelEntries.length + ' fuel entries, ' + maintenanceRecords.length + ' maintenance records.');
                        }
                    } else {
                        alert('Invalid file format. Please select a valid backup file.');
                    }
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid JSON backup file.');
                }
            };
            
            reader.readAsText(file);
        }

        function resetAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data including vehicles, fuel entries, and maintenance records.\n\nThis action cannot be undone!\n\nAre you absolutely sure?')) {
                if (confirm('üö® FINAL WARNING: All your data will be permanently lost!\n\nClick OK to proceed with deletion.')) {
                    vehicles = [];
                    fuelEntries = [];
                    maintenanceRecords = [];
                    currentVehicle = null;
                    
                    saveData();
                    updateDisplay();
                    updateDataOverview();
                    
                    alert('‚úÖ All data has been reset successfully.');
                }
            }
        }

        function resetCurrentVehicle() {
            if (!currentVehicle) {
                alert('Please select a vehicle first');
                return;
            }

            if (confirm('‚ö†Ô∏è WARNING: This will delete all data for "' + currentVehicle.name + '" including fuel entries and maintenance records.\n\nThis action cannot be undone!\n\nAre you sure?')) {
                var vehicleId = currentVehicle.id;
                
                // Remove vehicle and all its data
                vehicles = vehicles.filter(function(v) { return v.id !== vehicleId; });
                fuelEntries = fuelEntries.filter(function(e) { return e.vehicleId !== vehicleId; });
                maintenanceRecords = maintenanceRecords.filter(function(r) { return r.vehicleId !== vehicleId; });
                
                // Set new current vehicle
                currentVehicle = vehicles.length > 0 ? vehicles[0] : null;
                
                saveData();
                updateDisplay();
                updateDataOverview();
                
                alert('‚úÖ Vehicle data has been reset successfully.');
            }
        }

        function downloadFile(content, filename, mimeType) {
            var blob = new Blob([content], { type: mimeType });
            var url = window.URL.createObjectURL(blob);
            var link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // Fixed Delete Functions
        function deleteFuelEntry(entryId) {
            if (confirm('Are you sure you want to delete this fuel entry?')) {
                var entryIndex = -1;
                for (var i = 0; i < fuelEntries.length; i++) {
                    if (fuelEntries[i].id === entryId) {
                        entryIndex = i;
                        break;
                    }
                }
                
                if (entryIndex !== -1) {
                    fuelEntries.splice(entryIndex, 1);
                    saveData();
                    updateDisplay();
                    alert('‚úÖ Fuel entry deleted successfully!');
                } else {
                    alert('‚ùå Entry not found!');
                }
            }
        }

        function deleteVehicle(vehicleId) {
            if (confirm('Are you sure you want to delete this vehicle? All related fuel entries and maintenance records will also be deleted.')) {
                // Remove vehicle
                var vehicleIndex = -1;
                for (var i = 0; i < vehicles.length; i++) {
                    if (vehicles[i].id === vehicleId) {
                        vehicleIndex = i;
                        break;
                    }
                }
                
                if (vehicleIndex !== -1) {
                    vehicles.splice(vehicleIndex, 1);
                    
                    // Remove all related fuel entries
                    var newFuelEntries = [];
                    for (var i = 0; i < fuelEntries.length; i++) {
                        if (fuelEntries[i].vehicleId !== vehicleId) {
                            newFuelEntries.push(fuelEntries[i]);
                        }
                    }
                    fuelEntries = newFuelEntries;
                    
                    // Remove all related maintenance records
                    var newMaintenanceRecords = [];
                    for (var i = 0; i < maintenanceRecords.length; i++) {
                        if (maintenanceRecords[i].vehicleId !== vehicleId) {
                            newMaintenanceRecords.push(maintenanceRecords[i]);
                        }
                    }
                    maintenanceRecords = newMaintenanceRecords;
                    
                    // Update current vehicle
                    if (currentVehicle && currentVehicle.id === vehicleId) {
                        currentVehicle = vehicles.length > 0 ? vehicles[0] : null;
                    }
                    
                    saveData();
                    updateDisplay();
                    alert('‚úÖ Vehicle deleted successfully!');
                } else {
                    alert('‚ùå Vehicle not found!');
                }
            }
        }

        function deleteMaintenance(recordId) {
            if (confirm('Are you sure you want to delete this maintenance record?')) {
                var recordIndex = -1;
                for (var i = 0; i < maintenanceRecords.length; i++) {
                    if (maintenanceRecords[i].id === recordId) {
                        recordIndex = i;
                        break;
                    }
                }
                
                if (recordIndex !== -1) {
                    maintenanceRecords.splice(recordIndex, 1);
                    saveData();
                    updateDisplay();
                    alert('‚úÖ Maintenance record deleted successfully!');
                } else {
                    alert('‚ùå Record not found!');
                }
            }
        }

        // Initialize app
        window.onload = function() {
            loadData();
            updateDisplay();
            setTodayDate();
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            var modals = document.querySelectorAll('.modal');
            for (var i = 0; i < modals.length; i++) {
                if (event.target === modals[i]) {
                    modals[i].classList.remove('show');
                }
            }
        };
    </script>
</body>
</html>